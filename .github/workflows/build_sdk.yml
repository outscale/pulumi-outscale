name: ðŸ“¦ Build SDK

on:
    workflow_call:
        inputs:
            version:
                required: true
                type: string

env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    PULUMI_GO_DEP_ROOT: ${{ github.workspace }}/..
    PULUMI_LOCAL_NUGET: ${{ github.workspace }}/nuget
    TF_APPEND_USER_AGENT: pulumi
    PROVIDER_VERSION: ${{ inputs.version }}

jobs:
    build_sdk:
        runs-on: ubuntu-latest
        strategy:
            # We normally fail fast unless this is a PR from Renovate in which case
            # we'll always build all SDKs in case there are any changes to commit.
            fail-fast: ${{ ! contains(github.actor, 'renovate') }}
            matrix:
                language:
                    - dotnet
                    - go
                    - nodejs
                    - python
        steps:
            - name: ðŸ“¦ Checkout repo
              uses: actions/checkout@v4
              with:
                  persist-credentials: false
            - name: ðŸ“¦ Cache examples generation
              uses: actions/cache@v4
              with:
                  path: |
                      .pulumi/examples-cache
                  key: ${{ runner.os }}-${{ hashFiles('provider/go.sum') }}
            - name: ðŸ”§ Setup tools
              uses: ./.github/actions/setup-tools
              with:
                  tools: pulumictl, pulumicli, ${{ matrix.language }}
            - name: ðŸ”§ Prepare local workspace
              run: make prepare_local_workspace
            - name: ðŸ“¦ Download prerequisites
              uses: ./.github/actions/download-prerequisites
            - name: ðŸ”§ Update path
              run: echo "${{ github.workspace }}/bin" >> "$GITHUB_PATH"
            - name: ðŸ”§ Restore makefile progress
              run: make --touch provider schema
            - name: ðŸ”¨ Build SDK
              run: make build_${{ matrix.language }}
            - name: âœ… Check worktree clean
              id: worktreeClean
              uses: pulumi/git-status-check-action@v1
              with:
                  # Keep these in sync with the Renovate step below to avoid them getting checked in.
                  allowed-changes: |
                      sdk/**/pulumi-plugin.json
                      sdk/dotnet/*.csproj
                      sdk/go/**/pulumiUtilities.go
                      sdk/nodejs/package.json
                      sdk/python/pyproject.toml
            - name: ðŸ”€ Commit ${{ matrix.language }} SDK changes for Renovate
              # If the worktree is dirty and this is a Renovate PR to bump
              # dependencies, commit the updated SDK and push it back to the PR. The
              # job will still be marked as a failure.
              if: failure() && steps.worktreeClean.outcome == 'failure' && contains(github.actor, 'renovate') && github.event_name == 'pull_request'
              shell: bash
              run: |
                  git diff --quiet -- sdk && echo "no changes to sdk" && exit

                  git config --global user.email "bot@pulumi.com"
                  git config --global user.name "pulumi-bot"

                  # Stash local changes and check out the PR's branch directly.
                  git stash
                  git fetch
                  git checkout "origin/$HEAD_REF"

                  # Apply and add our changes, but don't commit any files we expect to
                  # always change due to versioning.
                  git stash pop
                  git add sdk
                  git reset \
                      sdk/python/*/pulumi-plugin.json \
                      sdk/python/pyproject.toml \
                      sdk/dotnet/pulumi-plugin.json \
                      sdk/dotnet/Pulumi.*.csproj \
                      sdk/go/*/pulumi-plugin.json \
                      sdk/go/*/internal/pulumiUtilities.go \
                      sdk/nodejs/package.json
                  git commit -m 'Commit ${{ matrix.language }} SDK for Renovate'

                  # Push with pulumi-bot credentials to trigger a re-run of the
                  # workflow. https://github.com/orgs/community/discussions/25702
                  git push https://pulumi-bot:${{ secrets.PULUMI_BOT_TOKEN }}@github.com/${{ github.repository }} \
                      "HEAD:$HEAD_REF"
              env:
                  # head_ref is untrusted so it's recommended to pass via env var to
                  # avoid injections.
                  HEAD_REF: ${{ github.head_ref }}

            - name: ðŸ“¦ Upload SDK
              uses: ./.github/actions/upload-sdk
              with:
                  language: ${{ matrix.language }}
