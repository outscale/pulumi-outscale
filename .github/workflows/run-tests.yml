name: ðŸ§ª Run-tests

on:
    pull_request:
        paths-ignore:
            - CHANGELOG.md

env:
    PR_COMMIT_SHA: ${{ github.event.client_payload.pull_request.head.sha }}
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    PULUMI_GO_DEP_ROOT: ${{ github.workspace }}/..
    PULUMI_LOCAL_NUGET: ${{ github.workspace }}/nuget
    TF_APPEND_USER_AGENT: pulumi

# This should cancel any previous runs of the same workflow on the same branch which are still running.
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    prerequisites:
        name: ðŸ“¦ Prerequisites
        if: github.event_name == 'repository_dispatch' ||
            github.event.pull_request.head.repo.full_name == github.repository
        permissions:
            contents: read
            pull-requests: write
        uses: ./.github/workflows/prerequisites.yml
        secrets: inherit
        with:
            default_branch: ${{ github.event.pull_request.base.ref }}
            is_pr: ${{ github.event_name == 'pull_request' }}
            is_automated: ${{ github.actor == 'dependabot[bot]' }}

    build_provider:
        name: ðŸ“¦ Build provider
        uses: ./.github/workflows/build_provider.yml
        needs: prerequisites
        secrets: inherit
        with:
            version: ${{ needs.prerequisites.outputs.version }}
            matrix: |
                {
                  "platform": [
                    {"os": "linux", "arch": "amd64"},
                    {"os": "windows", "arch": "amd64"}
                  ]
                }

    build_sdk:
        if: github.event_name == 'repository_dispatch' ||
            github.event.pull_request.head.repo.full_name == github.repository
        name: ðŸ“¦ Build SDK
        needs: prerequisites
        uses: ./.github/workflows/build_sdk.yml
        secrets: inherit
        with:
            version: ${{ needs.prerequisites.outputs.version }}

    comment-notification:
        if: github.event_name == 'repository_dispatch'
        name: ðŸ’¬ Comment notification
        permissions:
            pull-requests: write
        runs-on: ubuntu-latest
        steps:
            - id: run-url
              name: ðŸ”— Create URL to the run output
              run: echo "run-url=https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> "$GITHUB_OUTPUT"
            - name: ðŸ’¬ Update with result
              uses: peter-evans/create-or-update-comment@v4
              with:
                  body: "Please view the PR build: ${{ steps.run-url.outputs.run-url }}"
                  issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
                  repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
                  token: ${{ secrets.GITHUB_TOKEN }}
    sentinel:
        name: âœ… Sentinel
        if: github.event_name == 'repository_dispatch' ||
            github.event.pull_request.head.repo.full_name == github.repository
        permissions:
            statuses: write
        needs:
            - test
            - build_provider
            - license_check
        runs-on: ubuntu-latest
        steps:
            - name: âœ… Set status check
              uses: guibranco/github-status-action-v2@v1
              with:
                  authToken: ${{secrets.GITHUB_TOKEN}}
                  # Write an explicit status check called "Sentinel" which will only pass if this code really runs.
                  # This should always be a required check for PRs.
                  context: "Sentinel"
                  description: "All required checks passed"
                  state: "success"
                  # Write to the PR commit SHA if it's available as we don't want the merge commit sha,
                  # otherwise use the current SHA for any other type of build.
                  sha: ${{ github.event.pull_request.head.sha || github.sha }}

    test:
        name: ðŸ§ª Test
        # Don't run tests on PRs from forks.
        if: github.event_name == 'repository_dispatch' ||
            github.event.pull_request.head.repo.full_name == github.repository
        uses: ./.github/workflows/test.yml
        needs:
            - prerequisites
            - build_provider
            - build_sdk
        permissions:
            contents: read
            id-token: write
        secrets: inherit

    license_check:
        name: ðŸ“„ License Check
        uses: ./.github/workflows/license.yml
        secrets: inherit
