name: ðŸ“¦ Build Provider

on:
    workflow_call:
        inputs:
            version:
                required: true
                type: string
                description: Version of the provider to build
            matrix:
                required: false
                type: string
                default: |
                    {
                      "platform": [
                        {"os": "linux",   "arch": "amd64"},
                        {"os": "linux",   "arch": "arm64"},
                        {"os": "darwin",  "arch": "amd64"},
                        {"os": "darwin",  "arch": "arm64"},
                        {"os": "windows", "arch": "amd64"}
                      ]
                    }

jobs:
    build_provider:
        name: ðŸ“¦ Build ${{ matrix.platform.os }}-${{ matrix.platform.arch }}
        runs-on: ubuntu-latest
        env:
            PROVIDER_VERSION: ${{ inputs.version }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        strategy:
            fail-fast: true
            matrix: ${{ fromJSON(inputs.matrix) }}
        steps:
            - name: ðŸ“¦ Checkout repo
              uses: actions/checkout@v4
              with:
                  persist-credentials: false
            # Without ldid cross-compiling Node binaries on a Linux worker intended to work on darwin-arm64 fails to sign the
            # binaries properly and they do not work as expected. See https://github.com/pulumi/pulumi-awsx/issues/1490
            - uses: MOZGIII/install-ldid-action@v1
              with:
                  tag: v2.1.5-procursus2
            - name: ðŸ”§ Setup tools
              uses: ./.github/actions/setup-tools
              with:
                  tools: pulumictl, go
                  # use per-platform/arch caches instead since we are doing cross-builds
                  cache-go: false
            # Based on https://github.com/actions/cache/blob/main/examples.md#go---modules
            - name: ðŸ”§ Get GOCACHE
              id: gocache
              shell: bash
              run: |
                  echo "path=$(go env GOCACHE)" >> "${GITHUB_OUTPUT}"
            - name: ðŸ”§ Get GOMODCACHE
              id: gomodcache
              shell: bash
              run: |
                  echo "path=$(go env GOMODCACHE)" >> "${GITHUB_OUTPUT}"
            - name: ðŸ“¦ Go Cache
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ steps.gocache.outputs.path }}
                      ${{ steps.gomodcache.outputs.path }}
                  key: go-provider-${{ matrix.platform.os }}-${{ matrix.platform.arch }}-${{ hashFiles('provider/go.sum') }}
                  restore-keys: |
                      go-provider-${{ matrix.platform.os }}-${{ matrix.platform.arch }}-
            - name: ðŸ”§ Prepare local workspace before restoring previously built
              run: make prepare_local_workspace
            - name: ðŸ“¦ Restore prerequisites
              uses: ./.github/actions/download-prerequisites
            - name: ðŸ”§ Restore makefile progress
              # This mirrors the targets completed in the prerequisites job
              run: make --touch provider schema

            - name: ðŸ”¨ Build provider
              run: make "provider-${{ matrix.platform.os }}-${{ matrix.platform.arch }}"
              env:
                  SKIP_SIGNING: true

            - name: ðŸ“¦ Package provider
              run: make provider_dist-${{ matrix.platform.os }}-${{ matrix.platform.arch }}

            - name: ðŸ“¦ Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: pulumi-resource-outscale-v${{ inputs.version }}-${{ matrix.platform.os }}-${{ matrix.platform.arch }}.tar.gz
                  path: bin/pulumi-resource-outscale-v${{ inputs.version }}-${{ matrix.platform.os }}-${{ matrix.platform.arch }}.tar.gz
                  retention-days: 30
