env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    PULUMI_GO_DEP_ROOT: ${{ github.workspace }}/..
    PULUMI_LOCAL_NUGET: ${{ github.workspace }}/nuget
    TF_APPEND_USER_AGENT: pulumi
jobs:
    prerequisites:
        name: ðŸ“¦ Prerequisites
        uses: ./.github/workflows/prerequisites.yml
        secrets: inherit
        with:
            default_branch: ${{ github.event.repository.default_branch }}
            is_pr: ${{ github.event_name == 'pull_request' }}
            is_automated: ${{ github.actor == 'dependabot[bot]' }}

    build_provider:
        name: ðŸ“¦ Build provider
        uses: ./.github/workflows/build_provider.yml
        needs: prerequisites
        secrets: inherit
        with:
            version: ${{ needs.prerequisites.outputs.version }}

    build_sdk:
        name: "ðŸ“¦ Build SDK"
        needs: prerequisites
        uses: ./.github/workflows/build_sdk.yml
        secrets: inherit
        with:
            version: ${{ needs.prerequisites.outputs.version }}

    post_build:
        name: ðŸš€ Post build
        needs: prerequisites
        uses: ./.github/workflows/main-post-build.yml
        secrets: inherit
        with:
            version: ${{ needs.prerequisites.outputs.version }}

    license_check:
        name: ðŸ“„ License Check
        uses: ./.github/workflows/license.yml
        secrets: inherit

    publish:
        name: ðŸš€ Publish
        permissions:
            contents: write
        needs:
            - prerequisites
            - build_provider
            - test
            - license_check
        uses: ./.github/workflows/publish.yml
        secrets: inherit
        with:
            version: ${{ needs.prerequisites.outputs.version }}
            isPrerelease: true
            skipGoSdk: true
            skipJavaSdk: true

    tag_release_if_labeled_needs_release:
        name: ðŸ”– Tag release if labeled as needs-release
        needs: publish
        runs-on: ubuntu-latest
        steps:
            - name: âœ… Check if this commit needs release
              if: ${{ env.RELEASE_BOT_ENDPOINT != '' }}
              uses: pulumi/action-release-by-pr-label@main
              with:
                  command: "release-if-needed"
                  repo: ${{ github.repository }}
                  commit: ${{ github.sha }}
              env:
                  RELEASE_BOT_ENDPOINT: ${{ secrets.RELEASE_BOT_ENDPOINT }}
                  RELEASE_BOT_KEY: ${{ secrets.RELEASE_BOT_KEY }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    test:
        name: ðŸ§ª Test
        uses: ./.github/workflows/test.yml
        needs:
            - prerequisites
            - build_provider
            - build_sdk
        permissions:
            contents: read
        secrets: inherit

name: ðŸ‘· Main
on:
    workflow_dispatch: {}
    push:
        branches:
            - main
        paths-ignore:
            - "**.md"
        tags-ignore:
            - v*
            - sdk/*
            - "**"
