name: ‚¨ÜÔ∏è Upgrade provider
on:
    workflow_dispatch:
        inputs:
            version:
                description: |
                    The version of the upstream provider to upgrade to, without the 'v' prefix

                    If no version is specified, it will be inferred from the upstream provider's release tags.
                required: false
                type: string
            upgradeProviderVersion:
                description: |
                    Version of upgrade-provider to use. This must be a valid git reference in the pulumi/upgrade-provider repo. Defaults to "main"

                    See https://go.dev/ref/mod#versions for valid versions. E.g. "v0.1.0", "main", "da25dec".
                default: main
                type: string
    schedule:
        # 3 AM UTC ~ 8 PM PDT / 7 PM PST daily. Time chosen to run during off hours.
        - cron: 0 3 * * *

permissions:
    contents: write
    issues: write
    pull-requests: write

env:
    GH_TOKEN: ${{ secrets.PULUMI_PROVIDER_AUTOMATION_TOKEN || secrets.PULUMI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
    upgrade_provider:
        runs-on: ubuntu-latest
        steps:
            - name: üì¶ Checkout repo
              uses: actions/checkout@v4
              with:
                  # Persist credentials so upgrade-provider can push a new branch.
                  persist-credentials: true
            - name: üîß Setup tools
              uses: ./.github/actions/setup-tools
              with:
                  tools: pulumictl, pulumicli, dotnet, go, nodejs, python
            - name: ‚¨ÜÔ∏è Install upgrade provider
              run: go install github.com/pulumi/upgrade-provider@${{ inputs.upgradeProviderVersion || 'main' }}
              shell: bash
            - name: üîß Set up git identity
              run: |
                  git config --global user.name 'Outscale Bot'
                  git config --global user.email 'opensource+bot@outscale.com'
              shell: bash
            - name: ‚¨ÜÔ∏è Create issues for new upstream version
              if: inputs.version == ''
              id: upstream_version
              # This step outputs `latest_version` if there is a pending upgrade
              run: upgrade-provider "$REPO" --kind=check-upstream-version
              env:
                  REPO: ${{ github.repository }}
              shell: bash
            - name: ‚¨ÜÔ∏è Calculate target version
              id: target_version
              # Prefer the manually specified version if it exists
              # upstream_version will be empty if the provider is up-to-date
              run: echo "version=${{ github.event.inputs.version || steps.upstream_version.outputs.latest_version }}" >> "$GITHUB_OUTPUT"
              shell: bash
            - name: ‚¨ÜÔ∏è Call upgrade provider action
              id: upgrade_provider
              if: steps.target_version.outputs.version != ''
              continue-on-error: true
              uses: pulumi/pulumi-upgrade-provider-action@v0
              with:
                  kind: provider
                  email: opensource+bot@outscale.com
                  username: Outscale Bot
                  target-version: ${{ steps.target_version.outputs.version }}
                  allow-missing-docs: true
            - name: üí¨ Comment on upgrade issue if automated PR failed
              if: steps.upgrade_provider.outcome == 'failure'
              shell: bash
              run: |
                  issue_number=$(gh issue list --search "pulumiupgradeproviderissue" --repo "${{ github.repository }}" --json=number --jq=".[0].number")
                  gh issue comment "${issue_number}" --repo "${{ github.repository }}" --body "Failed to create automatic PR: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/"
